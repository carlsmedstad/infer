FROM almalinux:8.5

# Dependencies to opam
RUN dnf --assumeyes install \
    diffutils-3.6 \
    patch-2.7.6 \
    unzip-6.0 \
    bubblewrap-0.4.0 \
    && dnf clean all

ENV OPAM_VERSION=2.1.2
RUN curl -sSf -o /usr/local/bin/opam "https://github.com/ocaml/opam/releases/download/$OPAM_VERSION/opam-$OPAM_VERSION-x86_64-linux" \
    && chmod a+x /usr/local/bin/opam

# Dependencies to opam packages needed for infer
RUN dnf --assumeyes install \
    gcc-8.5.0 \
    make-4.2.1 \
    perl-5.26.3 \
    bzip2-1.0.6 \
    which-2.21 \
    autoconf-2.69 \
    zlib-devel-1.2.11 \
    sqlite-devel-3.26.0 \
    gmp-devel-6.1.2 \
    mpfr-devel-3.1.6 \
    automake-1.16.1 \
    && dnf clean all

# Dependencies to infer
RUN dnf --assumeyes install \
    cmake-3.20.2 \
    clang-12.0.1 \
    java-11-openjdk-devel-11.0.14.0.9 \
    python36-3.6.8 \
    && dnf clean all

ENV INFER_VERSION=1.1.0
# hadolint ignore=DL3003
RUN curl -sSf -O "https://github.com/facebook/infer/archive/v$INFER_VERSION.tar.gz" \
    && tar -xf "v$INFER_VERSION" \
    && cd infer-$INFER_VERSION \
    && CLANG_CMAKE_ARGS="-Wno-dev" ./build-infer.sh --yes \
    && make install
