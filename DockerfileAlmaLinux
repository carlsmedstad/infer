FROM almalinux:8.5

# Dependencies to opam
RUN dnf --assumeyes install \
    diffutils-3.6 \
    patch-2.7.6 \
    unzip-6.0 \
    gcc-8.5.0 \
    && dnf clean all

ENV OPAM_VERSION=2.1.2
RUN curl -sSfL -o /usr/local/bin/opam "https://github.com/ocaml/opam/releases/download/$OPAM_VERSION/opam-$OPAM_VERSION-x86_64-linux" \
    && chmod a+x /usr/local/bin/opam \
    && opam init --reinit --bare --disable-sandboxing --yes --auto-setup

# Dependencies to opam packages needed for infer
RUN dnf --assumeyes install \
    make-4.2.1 \
    perl-5.26.3 \
    bzip2-1.0.6 \
    which-2.21 \
    autoconf-2.69 \
    zlib-devel-1.2.11 \
    sqlite-devel-3.26.0 \
    gmp-devel-6.1.2 \
    mpfr-devel-3.1.6 \
    automake-1.16.1 \
    && dnf clean all

# Dependencies to Clang
RUN dnf --assumeyes install \
    cmake-3.20.2 \
    clang-12.0.1 \
    git-2.27.0 \
    python36-3.6.8 \
    && dnf clean all

# Dependencies to infer
RUN dnf --assumeyes install \
    java-11-openjdk-devel-11.0.14.0.9 \
    && dnf clean all

ENV INFER_VERSION=1.1.0
RUN curl -sSfL -O "https://github.com/facebook/infer/archive/v$INFER_VERSION.tar.gz" \
    && tar -xf "v$INFER_VERSION.tar.gz" \
    && rm "v$INFER_VERSION.tar.gz"

WORKDIR /infer-$INFER_VERSION

RUN ./build-infer.sh --only-setup-opam
RUN ./facebook-clang-plugins/clang/src/prepare_clang_src.sh
RUN eval "$(opam env)" \
    && JOBS=$(nproc) \
    && export JOBS \
    && export CC=clang CXX=clang++ \
    && ./autogen.sh \
    && ./configure \
    && ./facebook-clang-plugins/clang/setup.sh

# Dependencies for Infer build
ENV PATCHELF_VERSION=0.14.5
RUN curl -sSfL -O "https://github.com/NixOS/patchelf/releases/download/$PATCHELF_VERSION/patchelf-$PATCHELF_VERSION-x86_64.tar.gz" \
    && mkdir -p patchelf \
    && tar -xf "patchelf-$PATCHELF_VERSION-x86_64.tar.gz" -C patchelf \
    && cp patchelf/bin/patchelf /usr/local/bin \
    && rm "patchelf-$PATCHELF_VERSION-x86_64.tar.gz"

RUN make install-with-libs \
    BUILD_MODE=opt \
    PATCHELF=patchelf \
    DESTDIR="/infer-release" \
    libdir_relative_to_bindir="../lib"
